/**
 * req-helper
 * v0.0.1-beta.5
 * By kasslun@gmail.com
 * @license MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["req-helper"]={})}(this,(function(e){"use strict";const t=Promise.resolve();let o=.1;const r={};function n(e,n){if("function"!=typeof e)throw new TypeError("Failed to execute 'setDelay': parameter 1 is not of type 'Function'.");if(n<0)throw new TypeError("Failed to execute 'setDelay': parameter 2 is not a non-negative integer.");if(0===n){const n=--o+"";return r[n]=!0,t.then((()=>{r[n]&&(delete r[n],e())})),n}return setTimeout(e,n)}function i(e){switch(typeof e){case"undefined":break;case"string":delete r[e];break;default:clearTimeout(e)}}var a,c=(e,t,o)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'cache': parameter 1 is not of type 'Function'.");if(void 0!==t&&(!Number.isInteger(t)||t<0))throw new TypeError("Failed to execute 'cache': parameter 2 is not undefined or a non-negative integer.");if(void 0!==o&&"function"!=typeof o)throw new TypeError("Failed to execute 'cache' : optional parameter 3 is not undefined or of type 'Function'.");let r,a,c;const s=o?()=>{c&&(c=void 0,o&&o.call(r))}:()=>{c=void 0},p=function(){return r=r||this,c||(c=e.call(r),c.catch(s),void 0!==t&&c.then((()=>{a=n(s,t)}))),c};return p.refresh=()=>(c=void 0,i(a),p.call(r)),p.expire=()=>{s(),i(a)},p};!function(e){e[e.Rejected=-1]="Rejected",e[e.Pending=0]="Pending",e[e.Fulfilled=1]="Fulfilled"}(a||(a={}));const s=(e,t)=>{if(void 0!==t&&(!Number.isInteger(t)||t<0))throw TypeError(`Failed to execute 'packing': property '${e}' of parameter 2 is not a non-negative integer.`)};const p=()=>{};e.cache=c,e.deResend=(e,t,o=0)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'deResend': parameter 1 is not of type 'Function'.");if(void 0!==o&&(!Number.isInteger(o)||o<0))throw new TypeError("Failed to execute 'deResend': parameter 2 is not undefined or a non-negative integer.");let r,a,c=!1;const s=t?e=>{c!==e&&(c=e,t.call(r,c))}:e=>{c=e},p=function(...t){if(r=r||this,c)return Promise.reject(new Error("deResendRet"));s(!0);const i=e.call(this,...t);return void 0!==o&&(i.then((()=>{c&&(a=n((()=>{s(!1)}),o))})),i.catch((()=>{s(!1)}))),i};return p.enable=()=>{c&&(s(!1),i(a))},p},e.latest=function(e,{cacheTime:t,maxTasks:o=4}={maxTasks:4}){if("function"!=typeof e)throw new TypeError("Failed to execute 'latest': parameter 1 is not of type 'Function'.");if(void 0!==t&&(!Number.isInteger(t)||t<1))throw new TypeError("Failed to execute 'latest': optional property `cacheTime` of parameter 2 not is a positive integer");if(!Number.isInteger(o)||o<1)throw new TypeError("Failed to execute 'latest': optional property `maxTasks` of parameter 2 not is a positive integer");let r;const n=new Map;let i,s,p=0;const d=[];return function u(l,...f){r=r||this;const h=typeof l,y=void 0!==t&&("string"===h||"number"===h&&Number.isNaN(l));if(y&&n.has(l))return n.get(l)();if(i&&i.status===a.Pending&&i.reject(new Error("The latest aborted!")),p>=o)return d[0]&&(d[0](),d.shift()),new Promise(((e,t)=>{s&&s.reject("The latest aborted!"),s={resolve:e,reject:t,cacheKey:l,args:f}}));let g;const m=e=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'setAbortHandler': parameter 1 is not of type 'Function'.");g=e,d.push(e)};let w=()=>e.call(r,m,l,...f);y&&(w=c(w,t,(()=>{n.delete(l)})),n.set(l,w)),p++;const v=w();return i=function(e){const t={status:a.Pending};return t.handler=new Promise(((o,r)=>{e.then((e=>{t.status===a.Pending&&(o(e),t.status=a.Fulfilled)})).catch(t.reject=e=>{t.status===a.Pending&&(r(e),t.status=a.Rejected)})})),t}(v),v.catch((()=>{})).then((()=>{if(p--,s&&(s.resolve(u.call(r,s.cacheKey,...s.args)),s=void 0),g){const e=d.indexOf(g);-1!==e&&(g.call(r),d.splice(e,1))}})),i.handler}},e.packing=(e,t)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'packing': parameter 1 is not of type 'Function'.");if("object"!=typeof t)throw new TypeError("Failed to execute 'packing': parameter 2 is not of type 'Object'.");const{duration:o,waitTime:r,capacity:a}=t;if(void 0===o&&void 0===r&&void 0===a)throw new TypeError("Failed to execute 'packing': parameter 2 needs to have properties 'duration', 'capacity' or 'waitTime'.");if(void 0!==a&&(!Number.isInteger(a)||a<1))throw new TypeError("Failed to execute 'packing': property 'capacity' of parameter 2 is not a positive integer.");s("duration",o),s("waitTime",r);let c,p,d,u=!1,l=[];const f=function(...e){if(u=!0,c=c||this,e.length){l=l.concat(e);const t=l.length;if(a&&t>=a)return void f.pack()}void 0!==o&&void 0===p&&(p=n(f.pack,o)),void 0!==r&&(void 0!==d&&i(d),d=n(f.pack,r))};return f.pack=()=>{if(!u)return;if(void 0!==p&&(i(p),p=void 0),void 0!==d&&(i(d),d=void 0),!l.length)return;const t=l;l=[],e.call(c,t)},f},e.polling=(e,t=1e4)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'polling': parameter 1 is not of type 'Function'.");if(!Number.isInteger(t)||t<1)throw new TypeError("Failed to execute 'polling': parameter 2 is not a positive integer.");let o;const r=()=>{e().catch(p).then((()=>{o=n(r,t)}))};return r(),{stop(){void 0!==o&&(i(o),o=void 0)},resume(){void 0===o&&r()},refresh(e){if(void 0!==e){if(!Number.isInteger(e)||e<1)throw new TypeError("Failed to execute 'changeGap': parameter 1 is not a positive integer.");t=e}this.stop(),r()}}},Object.defineProperty(e,"__esModule",{value:!0})}));
