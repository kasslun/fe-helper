/**
 * req-helper
 * v0.0.3
 * By kasslun@gmail.com
 * @license MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).reqHelper={})}(this,(function(e){"use strict";const t=Promise.resolve();let n=.1;const r={};function o(e,o){if("function"!=typeof e)throw new TypeError("Failed to execute 'setDelay': parameter 1 is not of type 'Function'.");if(o<0)throw new TypeError("Failed to execute 'setDelay': parameter 2 is not a non-negative integer.");if(0===o){const o=--n+"";return r[o]=!0,t.then((()=>{r[o]&&(delete r[o],e())})),o}return setTimeout(e,o)}function i(e){switch(typeof e){case"undefined":break;case"string":delete r[e];break;default:clearTimeout(e)}}function a(e){return Object.prototype.toString.call(e)}function c(e){return"[object Promise]"===a(e)||"[object Object]"===a(e)&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.constructor.resolve&&"function"==typeof e.constructor.reject}var l,s=(e,t,n)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'cache': parameter 1 is not of type 'Function'.");if(null!=t&&(!Number.isInteger(t)||t<0))throw new TypeError("Failed to execute 'cache': parameter 2 is not undefined or a non-negative integer.");if(null!=n&&"function"!=typeof n)throw new TypeError("Failed to execute 'cache': optional parameter 3 is not undefined, null or of type 'Function'.");let r,a,l;const s=()=>{l&&(l=void 0,null==n||n.call(r))},u=function(n=!1){if(r=r||this,n&&s(),!l){if(l=e.call(r),!c(l))throw new TypeError("Failed to execute 'fn' in 'cache' : the return value of the 'fn' called is not of type 'Promise'.");l.catch(u.expire),null!=t&&(a=o(s,t))}return l};return u.expire=()=>{i(a),s()},u};!function(e){e[e.Rejected=-1]="Rejected",e[e.Pending=0]="Pending",e[e.Fulfilled=1]="Fulfilled"}(l||(l={}));const u=()=>{};const p=(e,t)=>{if(null!=t&&(!Number.isInteger(t)||t<0))throw TypeError(`Failed to execute 'packing': property '${e}' of parameter 2 is not a non-negative integer.`)};var f;!function(e){e[e.Init=0]="Init",e[e.UserTask=1]="UserTask",e[e.Timer=2]="Timer",e[e.WillStop=3]="WillStop"}(f||(f={}));const d=()=>{};e.cache=s,e.deResend=(e,t,n=0)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'deResend': parameter 1 is not of type 'Function'.");if(null!=t&&"function"!=typeof t)throw new TypeError("Failed to execute 'deResend': optional parameter 2 is not of type 'Function'.");if(null!=n&&(!Number.isInteger(n)||n<0))throw new TypeError("Failed to execute 'deResend': parameter 3 is not undefined or a non-negative integer.");let r,a,l=!1;const s=e=>{l!==e&&(l=e,null==t||t.call(r,l))},u=function(...t){if(r=r||this,l)return Promise.reject(new Error("prevent resend"));s(!0);const i=e.call(this,...t);if(!c(i))throw s(!1),new TypeError("Failed to execute 'fn' in 'deResend' : the return value of the 'fn' called is not of type 'Promise'.");return i.catch((()=>s(!1))).then((()=>{l&&(null!=n?a=o((()=>s(!1)),n):s(!1))})),i};return u.enable=()=>{l&&(s(!1),i(a))},u},e.latest=function(e,t={maxTasks:4}){if("function"!=typeof e)throw new TypeError("Failed to execute 'latest': parameter 1 is not of type 'Function'.");if("object"!=typeof t)throw new TypeError("Failed to execute 'latest': optional parameter 2 is not of type 'Object'.");const{cacheTime:n,maxTasks:r=4}=t;if(null!=n&&(!Number.isInteger(n)||n<1))throw new TypeError("Failed to execute 'latest': optional property `cacheTime` of parameter 2 not is a positive integer");if(null!=r&&(!Number.isInteger(r)||r<1))throw new TypeError("Failed to execute 'latest': optional property `maxTasks` of parameter 2 not is a positive integer");let o;const i=new Map;let a,p,f=0;const d=[];return function t(h,...y){o=o||this;const m=typeof h,w=null!=n&&("string"===m||"number"===m&&!Number.isNaN(h));if(w&&i.has(h))return i.get(h)();if((null==a?void 0:a.status)===l.Pending&&(a.reject(new Error("The latest aborted!")),a=void 0),f>=r){const e=new Promise(((e,t)=>{p&&p.reject("The latest aborted!"),p={resolve:e,reject:t,cacheKey:h,args:y}}));return"function"==typeof d[0]&&(d[0](),d.shift()),e}let T;const g=e=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'setAbortHandler': parameter 1 is not of type 'Function'.");T=d.push(e)-1};let F=()=>e.call(o,g,h,...y);w&&i.set(h,F=s(F,n,(()=>{i.delete(h)}))),f++;const x=F();if(!c(x))throw f--,new TypeError("Failed to execute 'proxy' in 'latest' : the return value of the parameter 1 of 'cache' call is not of type 'Promise'.");return x.catch(u).then((()=>{f--,void 0!==T&&d.splice(T,1),p&&(p.resolve(t.call(o,p.cacheKey,...p.args)),p=void 0)})),(a=function(e){const t={status:l.Pending};return t.handler=new Promise(((n,r)=>{e.then((e=>{t.status===l.Pending&&(n(e),t.status=l.Fulfilled)})).catch(t.reject=e=>{t.status===l.Pending&&(r(e),t.status=l.Rejected)})})),t}(x)).handler}},e.packing=(e,t)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'packing': parameter 1 is not of type 'Function'.");if("object"!=typeof t)throw new TypeError("Failed to execute 'packing': parameter 2 is not of type 'Object'.");const{duration:n,waitTime:r,capacity:a}=t;if(null==n&&null==r&&null==a)throw new TypeError("Failed to execute 'packing': parameter 2 needs to have properties 'duration', 'capacity' or 'waitTime'.");if(p("duration",n),p("waitTime",r),null!=a&&(!Number.isInteger(a)||a<1))throw new TypeError("Failed to execute 'packing': property 'capacity' of parameter 2 is not a positive integer.");let c,l,s,u=!1,f=[];const d=function(...e){u=!0,c=null!=c?c:this,e.length&&(f=f.concat(e),a&&f.length>=a)?d.pack():(null!=n&&void 0===l&&(l=o(d.pack,n)),null!=r&&(i(s),s=o(d.pack,r)))};return d.pack=()=>{if(!u)return;if(void 0!==l&&(i(l),l=void 0),void 0!==s&&(i(s),s=void 0),!f.length)return;const t=f;f=[],e.call(c,t)},d},e.polling=(e,t=1e4)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'polling': parameter 1 is not of type 'Function'.");if(null!=t&&!Number.isInteger(t)||t<1)throw new TypeError("Failed to execute 'polling': parameter 2 is not a positive integer.");let n,r=f.Init;const a=()=>{r=f.UserTask;const i=e();if(!c(i))throw r=f.Init,new TypeError("Failed to execute 'proxy' in 'polling' : the return value of the parameter 1 of 'cache' call is not of type 'Promise'.");i.catch(d).then((()=>{r===f.UserTask?(r=f.Timer,n=o(a,t)):r=f.Init}))};return a(),{stop(){r===f.Timer?(i(n),r=f.Init):r===f.UserTask&&(r=f.WillStop)},resume(){r===f.Init?a():r===f.WillStop&&(r=f.UserTask)},refresh(e){if(null!=e){if(!Number.isInteger(e)||e<1)throw new TypeError("Failed to execute 'changeGap': parameter 1 is not a positive integer.");t=e}switch(r){case f.Timer:i(n),r=f.Init,a();break;case f.WillStop:r=f.UserTask;break;case f.Init:a()}}}},Object.defineProperty(e,"__esModule",{value:!0})}));
