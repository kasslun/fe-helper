/**
 * req-helper
 * v0.0.2
 * By kasslun@gmail.com
 * @license MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).reqHelper={})}(this,(function(e){"use strict";const t=Promise.resolve();let o=.1;const r={};function n(e,n){if("function"!=typeof e)throw new TypeError("Failed to execute 'setDelay': parameter 1 is not of type 'Function'.");if(n<0)throw new TypeError("Failed to execute 'setDelay': parameter 2 is not a non-negative integer.");if(0===n){const n=--o+"";return r[n]=!0,t.then((()=>{r[n]&&(delete r[n],e())})),n}return setTimeout(e,n)}function i(e){switch(typeof e){case"undefined":break;case"string":delete r[e];break;default:clearTimeout(e)}}function a(e){return Object.prototype.toString.call(e)}function c(e){return"[object Promise]"===a(e)||"[object Object]"===a(e)&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.constructor.resolve&&"function"==typeof e.constructor.reject}var s,p=(e,t,o)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'cache': parameter 1 is not of type 'Function'.");if(void 0!==t&&(!Number.isInteger(t)||t<0))throw new TypeError("Failed to execute 'cache': parameter 2 is not undefined or a non-negative integer.");if(void 0!==o&&"function"!=typeof o)throw new TypeError("Failed to execute 'cache' : optional parameter 3 is not undefined or of type 'Function'.");let r,a,s;const p=o?()=>{s&&(s=void 0,o&&o.call(r))}:()=>{s=void 0},f=function(o=!1){if(r=r||this,o&&p(),!s){if(s=e.call(r),!c(s))throw new TypeError("Failed to execute 'proxy' in 'cache' : the return value of the parameter 1 of 'cache' call is not of type 'Promise'.");s.catch(p),void 0!==t&&(a=n(p,t))}return s};return f.expire=()=>{p(),i(a)},f};!function(e){e[e.Rejected=-1]="Rejected",e[e.Pending=0]="Pending",e[e.Fulfilled=1]="Fulfilled"}(s||(s={}));const f=(e,t)=>{if(void 0!==t&&(!Number.isInteger(t)||t<0))throw TypeError(`Failed to execute 'packing': property '${e}' of parameter 2 is not a non-negative integer.`)};var l;!function(e){e[e.Init=0]="Init",e[e.UserTask=1]="UserTask",e[e.Timer=2]="Timer",e[e.WillStop=3]="WillStop"}(l||(l={}));const u=()=>{};e.cache=p,e.deResend=(e,t,o=0)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'deResend': parameter 1 is not of type 'Function'.");if(void 0!==t&&"function"!=typeof t)throw new TypeError("Failed to execute 'deResend': optional parameter 2 is not of type 'Function'.");if(void 0!==o&&(!Number.isInteger(o)||o<0))throw new TypeError("Failed to execute 'deResend': parameter 3 is not undefined or a non-negative integer.");let r,a,s=!1;const p=t?e=>{s!==e&&(s=e,t.call(r,s))}:e=>{s=e},f=function(...t){if(r=r||this,s)return Promise.reject(new Error("deResendRet"));p(!0);const i=e.call(this,...t);if(!c(i))throw new TypeError("Failed to execute 'proxy' in 'deResend' : the return value of the parameter 1 of 'cache' call is not of type 'Promise'.");return void 0!==o&&(i.then((()=>{s&&(a=n((()=>{p(!1)}),o))})),i.catch((()=>{p(!1)}))),i};return f.enable=()=>{s&&(p(!1),i(a))},f},e.latest=function(e,t={maxTasks:4}){if("function"!=typeof e)throw new TypeError("Failed to execute 'latest': parameter 1 is not of type 'Function'.");if("object"!=typeof t)throw new TypeError("Failed to execute 'latest': optional parameter 2 is not of type 'Object'.");const{cacheTime:o,maxTasks:r=4}=t;if(void 0!==o&&(!Number.isInteger(o)||o<1))throw new TypeError("Failed to execute 'latest': optional property `cacheTime` of parameter 2 not is a positive integer");if(!Number.isInteger(r)||r<1)throw new TypeError("Failed to execute 'latest': optional property `maxTasks` of parameter 2 not is a positive integer");let n;const i=new Map;let a,f,l=0;const u=[];return function t(d,...h){n=n||this;const y=typeof d,m=void 0!==o&&("string"===y||"number"===y&&Number.isNaN(d));if(m&&i.has(d))return i.get(d)();if(a&&a.status===s.Pending&&a.reject(new Error("The latest aborted!")),l>=r)return u[0]&&(u[0](),u.shift()),new Promise(((e,t)=>{f&&f.reject("The latest aborted!"),f={resolve:e,reject:t,cacheKey:d,args:h}}));let w;const T=e=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'setAbortHandler': parameter 1 is not of type 'Function'.");w=e,u.push(e)};let g=()=>e.call(n,T,d,...h);m&&(g=p(g,o,(()=>{i.delete(d)})),i.set(d,g)),l++;const v=g();if(!c(v))throw new TypeError("Failed to execute 'proxy' in 'latest' : the return value of the parameter 1 of 'cache' call is not of type 'Promise'.");return a=function(e){const t={status:s.Pending};return t.handler=new Promise(((o,r)=>{e.then((e=>{t.status===s.Pending&&(o(e),t.status=s.Fulfilled)})).catch(t.reject=e=>{t.status===s.Pending&&(r(e),t.status=s.Rejected)})})),t}(v),v.catch((()=>{})).then((()=>{if(l--,w){const e=u.indexOf(w);-1!==e&&u.splice(e,1)}f&&(f.resolve(t.call(n,f.cacheKey,...f.args)),f=void 0)})),a.handler}},e.packing=(e,t)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'packing': parameter 1 is not of type 'Function'.");if("object"!=typeof t)throw new TypeError("Failed to execute 'packing': parameter 2 is not of type 'Object'.");const{duration:o,waitTime:r,capacity:a}=t;if(void 0===o&&void 0===r&&void 0===a)throw new TypeError("Failed to execute 'packing': parameter 2 needs to have properties 'duration', 'capacity' or 'waitTime'.");if(f("duration",o),f("waitTime",r),void 0!==a&&(!Number.isInteger(a)||a<1))throw new TypeError("Failed to execute 'packing': property 'capacity' of parameter 2 is not a positive integer.");let c,s,p,l=!1,u=[];const d=function(...e){if(l=!0,c=c||this,e.length){u=u.concat(e);const t=u.length;if(a&&t>=a)return void d.pack()}void 0!==o&&void 0===s&&(s=n(d.pack,o)),void 0!==r&&(void 0!==p&&i(p),p=n(d.pack,r))};return d.pack=()=>{if(!l)return;if(void 0!==s&&(i(s),s=void 0),void 0!==p&&(i(p),p=void 0),!u.length)return;const t=u;u=[],e.call(c,t)},d},e.polling=(e,t=1e4)=>{if("function"!=typeof e)throw new TypeError("Failed to execute 'polling': parameter 1 is not of type 'Function'.");if(!Number.isInteger(t)||t<1)throw new TypeError("Failed to execute 'polling': parameter 2 is not a positive integer.");let o,r=l.Init;const a=()=>{r=l.UserTask;const i=e();if(!c(i))throw r=l.Init,new TypeError("Failed to execute 'proxy' in 'polling' : the return value of the parameter 1 of 'cache' call is not of type 'Promise'.");i.catch(u).then((()=>{r===l.UserTask?(r=l.Timer,o=n(a,t)):r=l.Init}))};return a(),{stop(){r===l.Timer?(i(o),r=l.Init):r===l.UserTask&&(r=l.WillStop)},resume(){r===l.Init?a():r===l.WillStop&&(r=l.UserTask)},refresh(e){if(void 0!==e){if(!Number.isInteger(e)||e<1)throw new TypeError("Failed to execute 'changeGap': parameter 1 is not a positive integer.");t=e}switch(r){case l.Timer:i(o),r=l.Init,a();break;case l.WillStop:r=l.UserTask;break;case l.Init:a()}}}},Object.defineProperty(e,"__esModule",{value:!0})}));
